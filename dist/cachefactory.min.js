!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define("cachefactory",t):e.CacheFactory=t()}(this,function(){"use strict";function e(e,t){if(e||(e=function(e){return e}),t||(t=function(e,t){return e===t}),"function"!=typeof e)throw new Error('BinaryHeap([weightFunc][, compareFunc]): "weightFunc" must be a function!');if("function"!=typeof t)throw new Error('BinaryHeap([weightFunc][, compareFunc]): "compareFunc" must be a function!');this.weightFunc=e,this.compareFunc=t,this.heap=[]}var t=function(e,t,r){for(var i=e[r],s=t(i);r>0;){var a=Math.floor((r+1)/2)-1,n=e[a];if(s>=t(n))break;e[a]=i,e[r]=n,r=a}},r=function(e,t,r){for(var i=e.length,s=e[r],a=t(s);;){var n=2*(r+1),o=n-1,c=null;if(o<i){var h=e[o],u=t(h);u<a&&(c=o)}if(n<i){var l=e[n],$=t(l);$<(null===c?a:t(e[o]))&&(c=n)}if(null===c)break;e[r]=e[c],e[c]=s,r=c}},i=e.prototype;i.push=function(e){this.heap.push(e),t(this.heap,this.weightFunc,this.heap.length-1)},i.peek=function(){return this.heap[0]},i.pop=function(){var e=this.heap[0],t=this.heap.pop();return this.heap.length>0&&(this.heap[0]=t,r(this.heap,this.weightFunc,0)),e},i.remove=function(e){for(var i=this.heap.length,s=0;s<i;s++)if(this.compareFunc(this.heap[s],e)){var a=this.heap[s],n=this.heap.pop();return s!==i-1&&(this.heap[s]=n,t(this.heap,this.weightFunc,s),r(this.heap,this.weightFunc,s)),a}return null},i.removeAll=function(){this.heap=[]},i.size=function(){return this.heap.length};var s={capacity:Number.MAX_VALUE,cacheFlushInterval:null,deleteOnExpire:"none",enabled:!0,onExpire:null,maxAge:Number.MAX_VALUE,recycleFreq:1e3,storageMode:"memory",storageImpl:null,storagePrefix:"cachefactory.caches.",storeOnReject:!1,storeOnResolve:!1},a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},n=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),c=null;try{c=window.Promise}catch(e){}var h={equals:function(e,t){return e===t},fromJson:function(e){return JSON.parse(e)},isFunction:function(e){return"function"==typeof e},isNumber:function(e){return"number"==typeof e},isObject:function(e){return null!==e&&"object"===("undefined"==typeof e?"undefined":a(e))},isPromise:function(e){return e&&h.isFunction(e.then)},isString:function(e){return"string"==typeof e},toJson:function(e){return JSON.stringify(e)},Promise:c},u="Cannot assign to read only property",l=function(){function t(r){var i=this,s=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];if(n(this,t),!h.isString(r))throw new TypeError('"id" must be a string!');Object.defineProperties(this,{$$cacheFlushInterval:{writable:!0,value:void 0},$$cacheFlushIntervalId:{writable:!0,value:void 0},$$capacity:{writable:!0,value:void 0},$$data:{writable:!0,value:{}},$$deleteOnExpire:{writable:!0,value:void 0},$$enabled:{writable:!0,value:void 0},$$expiresHeap:{writable:!0,value:new e(function(e){return e.accessed},h.equals)},$$initializing:{writable:!0,value:!0},$$lruHeap:{writable:!0,value:new e(function(e){return e.accessed},h.equals)},$$maxAge:{writable:!0,value:void 0},$$onExpire:{writable:!0,value:void 0},$$prefix:{writable:!0,value:""},$$promises:{writable:!0,value:{}},$$recycleFreq:{writable:!0,value:void 0},$$recycleFreqId:{writable:!0,value:void 0},$$storage:{writable:!0,value:void 0},$$storageMode:{writable:!0,value:void 0},$$storagePrefix:{writable:!0,value:void 0},$$storeOnReject:{writable:!0,value:void 0},$$storeOnResolve:{writable:!0,value:void 0},$$parent:{value:s.parent},cacheFlushInterval:{enumerable:!0,get:function(){return i.$$cacheFlushInterval},set:function(){throw new Error(u+" 'cacheFlushInterval'")}},capacity:{enumerable:!0,get:function(){return i.$$capacity},set:function(){throw new Error(u+" 'capacity'")}},deleteOnExpire:{enumerable:!0,get:function(){return i.$$deleteOnExpire},set:function(){throw new Error(u+" 'deleteOnExpire'")}},enabled:{enumerable:!0,get:function(){return i.$$enabled},set:function(){throw new Error(u+" 'enabled'")}},id:{enumerable:!0,value:r},maxAge:{enumerable:!0,get:function(){return i.$$maxAge},set:function(){throw new Error(u+" 'maxAge'")}},onExpire:{enumerable:!0,get:function(){return i.$$onExpire},set:function(){throw new Error(u+" 'onExpire'")}},recycleFreq:{enumerable:!0,get:function(){return i.$$recycleFreq},set:function(){throw new Error(u+" 'recycleFreq'")}},storageMode:{enumerable:!0,get:function(){return i.$$storageMode},set:function(){throw new Error(u+" 'storageMode'")}},storagePrefix:{enumerable:!0,get:function(){return i.$$storagePrefix},set:function(){throw new Error(u+" 'storagePrefix'")}},storeOnReject:{enumerable:!0,get:function(){return i.$$storeOnReject},set:function(){throw new Error(u+" 'storeOnReject'")}},storeOnResolve:{enumerable:!0,get:function(){return i.$$storeOnResolve},set:function(){throw new Error(u+" 'storeOnResolve'")}}}),this.setOptions(s,!0),this.$$initializing=!1}return o(t,[{key:"destroy",value:function(){clearInterval(this.$$cacheFlushIntervalId),clearInterval(this.$$recycleFreqId),this.removeAll(),this.$$storage&&(this.$$storage().removeItem(this.$$prefix+".keys"),this.$$storage().removeItem(this.$$prefix)),this.$$storage=null,this.$$data=null,this.$$lruHeap=null,this.$$expiresHeap=null,this.$$prefix=null,this.$$parent&&(this.$$parent.caches[this.id]=void 0)}},{key:"disable",value:function(){this.$$enabled=!1}},{key:"enable",value:function(){this.$$enabled=!0}},{key:"get",value:function(e){var t=this,r=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];if(Array.isArray(e)){var i=function(){var i=e,s=[];return i.forEach(function(e){var i=t.get(e,r);null!==i&&void 0!==i&&s.push(i)}),{v:s}}();if("object"===("undefined"==typeof i?"undefined":a(i)))return i.v}else if(h.isNumber(e)&&(e=""+e),!this.enabled)return;if(!h.isString(e))throw new TypeError('"key" must be a string!');if(!r||!h.isObject(r))throw new TypeError('"options" must be an object!');if(r.onExpire&&!h.isFunction(r.onExpire))throw new TypeError('"options.onExpire" must be a function!');var s=void 0;if(this.$$storage){if(this.$$promises[e])return this.$$promises[e];var n=this.$$storage().getItem(this.$$prefix+".data."+e);n&&(s=h.fromJson(n))}else h.isObject(this.$$data)&&(s=this.$$data[e]);if(s){var o=s.value,c=(new Date).getTime();return this.$$storage?(this.$$lruHeap.remove({key:e,accessed:s.accessed}),s.accessed=c,this.$$lruHeap.push({key:e,accessed:c})):(this.$$lruHeap.remove(s),s.accessed=c,this.$$lruHeap.push(s)),"passive"===this.$$deleteOnExpire&&"expires"in s&&s.expires<c?(this.remove(e),this.$$onExpire?this.$$onExpire(e,s.value,r.onExpire):r.onExpire&&r.onExpire.call(this,e,s.value),o=void 0):this.$$storage&&this.$$storage().setItem(this.$$prefix+".data."+e,h.toJson(s)),o}}},{key:"info",value:function(e){if(!e)return{id:this.id,capacity:this.capacity,maxAge:this.maxAge,deleteOnExpire:this.deleteOnExpire,onExpire:this.onExpire,cacheFlushInterval:this.cacheFlushInterval,recycleFreq:this.recycleFreq,storageMode:this.storageMode,storageImpl:this.$$storage?this.$$storage():void 0,enabled:this.enabled,size:this.$$lruHeap&&this.$$lruHeap.size()||0};var t=void 0;if(this.$$storage){var r=this.$$storage().getItem(this.$$prefix+".data."+e);r&&(t=h.fromJson(r))}else h.isObject(this.$$data)&&(t=this.$$data[e]);return t?{created:t.created,accessed:t.accessed,expires:t.expires,isExpired:(new Date).getTime()-t.created>(t.maxAge||this.$$maxAge)}:void 0}},{key:"keys",value:function(){var e=this;if(this.$$storage){var t=this.$$storage().getItem(this.$$prefix+".keys");return t?h.fromJson(t):[]}return Object.keys(this.$$data).filter(function(t){return e.$$data[t]})}},{key:"keySet",value:function(){var e={};return this.keys().forEach(function(t){e[t]=t}),e}},{key:"put",value:function(e,t){var r=this,i=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],s=void 0!==i.storeOnResolve?!!i.storeOnResolve:this.$$storeOnResolve,a=void 0!==i.storeOnReject?!!i.storeOnReject:this.$$storeOnReject,n=function(t,i){return function(s){if(t&&(r.$$promises[e]=void 0,h.isObject(s)&&"status"in s&&"data"in s?(s=[s.status,s.data,s.headers(),s.statusText],r.put(e,s)):r.put(e,s)),i){if(h.Promise)return h.Promise.reject(s);throw s}return s}};if(this.$$enabled&&h.isObject(this.$$data)&&null!==t&&void 0!==t){if(h.isNumber(e)&&(e=""+e),!h.isString(e))throw new TypeError('"key" must be a string!');var o=(new Date).getTime(),c={key:e,value:h.isPromise(t)?t.then(n(s,!1),n(a,!0)):t,created:void 0===i.created?o:i.created,accessed:void 0===i.accessed?o:i.accessed};if(h.isNumber(i.maxAge)&&(c.maxAge=i.maxAge),void 0===i.expires?c.expires=c.created+(c.maxAge||this.$$maxAge):c.expires=i.expires,this.$$storage){if(h.isPromise(c.value))return this.$$promises[e]=c.value,this.$$promises[e];var u=this.$$storage().getItem(this.$$prefix+".keys"),l=u?h.fromJson(u):[],$=this.$$storage().getItem(this.$$prefix+".data."+e);$&&this.remove(e),this.$$expiresHeap.push({key:e,expires:c.expires}),this.$$lruHeap.push({key:e,accessed:c.accessed}),this.$$storage().setItem(this.$$prefix+".data."+e,h.toJson(c));var f=!1;l.forEach(function(t){if(t===e)return f=!0,!1}),f||l.push(e),this.$$storage().setItem(this.$$prefix+".keys",h.toJson(l))}else this.$$data[e]&&this.remove(e),this.$$expiresHeap.push(c),this.$$lruHeap.push(c),this.$$data[e]=c,this.$$promises[e]=void 0;return this.$$lruHeap.size()>this.$$capacity&&this.remove(this.$$lruHeap.peek().key),t}}},{key:"remove",value:function(e){if(h.isNumber(e)&&(e=""+e),this.$$promises[e]=void 0,this.$$storage){var t=this.$$storage().getItem(this.$$prefix+".data."+e);if(t){var r=h.fromJson(t);this.$$lruHeap.remove({key:e,accessed:r.accessed}),this.$$expiresHeap.remove({key:e,expires:r.expires}),this.$$storage().removeItem(this.$$prefix+".data."+e);var i=this.$$storage().getItem(this.$$prefix+".keys"),s=i?h.fromJson(i):[],a=s.indexOf(e);return a>=0&&s.splice(a,1),this.$$storage().setItem(this.$$prefix+".keys",h.toJson(s)),r.value}}else if(h.isObject(this.$$data)){var n=this.$$data[e]?this.$$data[e].value:void 0;return this.$$lruHeap.remove(this.$$data[e]),this.$$expiresHeap.remove(this.$$data[e]),this.$$data[e]=void 0,n}}},{key:"removeAll",value:function(){var e=this,t=this.$$storage,r=this.keys();this.$$lruHeap.removeAll(),this.$$expiresHeap.removeAll(),t?(t().setItem(this.$$prefix+".keys",h.toJson([])),r.forEach(function(r){t().removeItem(e.$$prefix+".data."+r)})):h.isObject(this.$$data)&&(this.$$data={}),this.$$promises={}}},{key:"removeExpired",value:function(){for(var e=this,t=(new Date).getTime(),r={},i=void 0;(i=this.$$expiresHeap.peek())&&i.expires<=t;)r[i.key]=i.value?i.value:null,this.$$expiresHeap.pop();return Object.keys(r).forEach(function(t){e.remove(t)}),this.$$onExpire&&Object.keys(r).forEach(function(t){e.$$onExpire(t,r[t])}),r}},{key:"setCacheFlushInterval",value:function(e){var t=this;if(null===e)this.$$cacheFlushInterval=null;else{if(!h.isNumber(e))throw new TypeError('"cacheFlushInterval" must be a number!');if(e<=0)throw new Error('"cacheFlushInterval" must be greater than zero!')}this.$$cacheFlushInterval=e,clearInterval(this.$$cacheFlushIntervalId),this.$$cacheFlushIntervalId=void 0,this.$$cacheFlushInterval&&(this.$$cacheFlushIntervalId=setInterval(function(){return t.removeAll()},this.$$cacheFlushInterval))}},{key:"setCapacity",value:function(e){if(null===e)this.$$capacity=Number.MAX_VALUE;else{if(!h.isNumber(e))throw new TypeError('"capacity" must be a number!');if(e<=0)throw new Error('"capacity" must be greater than zero!');this.$$capacity=e}for(var t={};this.$$lruHeap.size()>this.$$capacity;)t[this.$$lruHeap.peek().key]=this.remove(this.$$lruHeap.peek().key);return t}},{key:"setDeleteOnExpire",value:function(e,t){if(null===e)e="none";else{if(!h.isString(e))throw new TypeError('"deleteOnExpire" must be a string!');if("none"!==e&&"passive"!==e&&"aggressive"!==e)throw new Error('"deleteOnExpire" must be "none", "passive" or "aggressive"!')}this.$$deleteOnExpire=e,t!==!1&&this.setRecycleFreq(this.$$recycleFreq)}},{key:"setMaxAge",value:function(e){var t=this;if(null===e)this.$$maxAge=Number.MAX_VALUE;else{if(!h.isNumber(e))throw new TypeError('"maxAge" must be a number!');if(e<=0)throw new Error('"maxAge" must be greater than zero!');this.$$maxAge=e}var r=this.keys();return this.$$expiresHeap.removeAll(),this.$$storage?r.forEach(function(e){var r=t.$$storage().getItem(t.$$prefix+".data."+e);if(r){var i=h.fromJson(r);t.$$maxAge===Number.MAX_VALUE?i.expires=Number.MAX_VALUE:i.expires=i.created+(i.maxAge||t.$$maxAge),t.$$expiresHeap.push({key:e,expires:i.expires})}}):r.forEach(function(e){var r=t.$$data[e];r&&(t.$$maxAge===Number.MAX_VALUE?r.expires=Number.MAX_VALUE:r.expires=r.created+(r.maxAge||t.$$maxAge),t.$$expiresHeap.push(r))}),"aggressive"===this.$$deleteOnExpire?this.removeExpired():{}}},{key:"setOnExpire",value:function(e){if(null===e)this.$$onExpire=null;else{if(!h.isFunction(e))throw new TypeError('"onExpire" must be a function!');this.$$onExpire=e}}},{key:"setOptions",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=!(arguments.length<=1||void 0===arguments[1])&&arguments[1];if(!h.isObject(e))throw new TypeError('"options" must be an object!');void 0!==e.storagePrefix?this.$$storagePrefix=e.storagePrefix:t&&(this.$$storagePrefix=s.storagePrefix),this.$$prefix=this.$$storagePrefix+this.id,void 0!==e.enabled?this.$$enabled=!!e.enabled:t&&(this.$$enabled=s.enabled),void 0!==e.deleteOnExpire?this.setDeleteOnExpire(e.deleteOnExpire,!1):t&&this.setDeleteOnExpire(s.deleteOnExpire,!1),void 0!==e.recycleFreq?this.setRecycleFreq(e.recycleFreq):t&&this.setRecycleFreq(s.recycleFreq),void 0!==e.maxAge?this.setMaxAge(e.maxAge):t&&this.setMaxAge(s.maxAge),void 0!==e.storeOnResolve?this.$$storeOnResolve=!!e.storeOnResolve:t&&(this.$$storeOnResolve=s.storeOnResolve),void 0!==e.storeOnReject?this.$$storeOnReject=!!e.storeOnReject:t&&(this.$$storeOnReject=s.storeOnReject),void 0!==e.capacity?this.setCapacity(e.capacity):t&&this.setCapacity(s.capacity),void 0!==e.cacheFlushInterval?this.setCacheFlushInterval(e.cacheFlushInterval):t&&this.setCacheFlushInterval(s.cacheFlushInterval),void 0!==e.onExpire?this.setOnExpire(e.onExpire):t&&this.setOnExpire(s.onExpire),void 0!==e.storageMode||void 0!==e.storageImpl?this.setStorageMode(e.storageMode||s.storageMode,e.storageImpl||s.storageImpl):t&&this.setStorageMode(s.storageMode,s.storageImpl)}},{key:"setRecycleFreq",value:function(e){var t=this;if(null===e)this.$$recycleFreq=null;else{if(!h.isNumber(e))throw new TypeError('"recycleFreq" must be a number!');if(e<=0)throw new Error('"recycleFreq" must be greater than zero!');this.$$recycleFreq=e}clearInterval(this.$$recycleFreqId),"aggressive"===this.$$deleteOnExpire&&this.$$recycleFreq?this.$$recycleFreqId=setInterval(function(){return t.removeExpired()},this.$$recycleFreq):this.$$recycleFreqId=void 0}},{key:"setStorageMode",value:function(e,t){var r=this;if(!h.isString(e))throw new TypeError('"storageMode" must be a string!');if("memory"!==e&&"localStorage"!==e&&"sessionStorage"!==e)throw new Error('"storageMode" must be "memory", "localStorage", or "sessionStorage"!');var i=this.$$storage,s=this.$$data,a=!1,n={},o=function(e,t){var i=r.keys(),s=h.isObject(t);i.forEach(function(i){if(e){var o=e().getItem(r.$$prefix+".data."+i);o&&(n[i]=h.fromJson(o))}else s&&(n[i]=t[i]);r.remove(i),a||(a=!0)})};if(this.$$initializing||o(i,s),this.$$storageMode=e,t){if(!h.isObject(t))throw new TypeError('"storageImpl" must be an object!');if("function"!=typeof t.setItem)throw new Error('"storageImpl" must implement "setItem(key, value)"!');if("function"!=typeof t.getItem)throw new Error('"storageImpl" must implement "getItem(key)"!');if("function"!=typeof t.removeItem)throw new Error('"storageImpl" must implement "removeItem(key)"!');this.$$storage=function(){return t}}else if("localStorage"===this.$$storageMode)try{localStorage.setItem("cachefactory","cachefactory"),localStorage.removeItem("cachefactory"),this.$$storage=function(){return localStorage}}catch(e){this.$$storage=null,this.$$storageMode="memory"}else if("sessionStorage"===this.$$storageMode)try{sessionStorage.setItem("cachefactory","cachefactory"),sessionStorage.removeItem("cachefactory"),this.$$storage=function(){return sessionStorage}}catch(e){this.$$storage=null,this.$$storageMode="memory"}else this.$$storage=null,this.$$storageMode="memory";this.$$initializing&&o(this.$$storage,this.$$data),a&&Object.keys(n).forEach(function(e){var t=n[e];r.put(e,t.value,{created:t.created,accessed:t.accessed,expires:t.expires})})}},{key:"touch",value:function(e,t){var r=this;if(e){var i=this.get(e,{onExpire:function(e,t){return r.put(e,t)}});i&&this.put(e,i,t)}else for(var s=this.keys(),a=0;a<s.length;a++)this.touch(s[a],t)}},{key:"values",value:function(){var e=this;return this.keys().map(function(t){return e.get(t)})}}]),t}(),$=function(){function e(){n(this,e),Object.defineProperty(this,"caches",{writable:!0,value:{}})}return o(e,[{key:"clearAll",value:function(){var e=this;this.keys().forEach(function(t){e.get(t).removeAll()})}},{key:"createCache",value:function(t){var r=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];if(this.caches[t])throw new Error('cache "'+t+'" already exists!');return r.parent=this,this.caches[t]=new e.Cache(t,r),this.caches[t]}},{key:"destroy",value:function(e){this.get(e).destroy(),this.caches[e]=void 0}},{key:"destroyAll",value:function(){var e=this;this.keys().forEach(function(t){e.get(t).destroy()}),this.caches={}}},{key:"disableAll",value:function(){var e=this;this.keys().forEach(function(t){e.get(t).disable()})}},{key:"enableAll",value:function(){var e=this;this.keys().forEach(function(t){e.get(t).enable()})}},{key:"exists",value:function(e){return!!this.caches[e]}},{key:"get",value:function(e){var t=this.caches[e];if(!t)throw new ReferenceError('Cache "'+e+'" does not exist!');return t}},{key:"info",value:function t(){var r=this,i=this.keys(),t={size:i.length,caches:{}};return i.forEach(function(e){t.caches[e]=r.get(e).info()}),Object.keys(e.defaults).forEach(function(r,i){t[r]=e.defaults[r]}),t}},{key:"keys",value:function(){var e=this;return Object.keys(this.caches).filter(function(t){return e.caches[t]})}},{key:"keySet",value:function(){var e={};return this.keys().forEach(function(t){e[t]=t}),e}},{key:"removeExpiredFromAll",value:function(){var e=this,t={};return this.keys().forEach(function(r){t[r]=e.get(r).removeExpired()}),t}},{key:"touchAll",value:function(){var e=this;this.keys().forEach(function(t){e.get(t).touch()})}}]),e}();return $.BinaryHeap=e,$.Cache=l,$.defaults=s,$.utils=h,$});
//# sourceMappingURL=cachefactory.min.map